<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Управление временем жизни задач в Go с помощью пакета context">
    <meta name="author" content="Владислав Дедов">
    <title>Управление временем жизни задач в Go с context - Пишу про IT</title>
    <link rel="icon" type="image/svg+xml" href="../favicon.svg">
    <link rel="icon" type="image/x-icon" href="../favicon.ico">
    <link rel="stylesheet" href="../assets/css/style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/github-dark.min.css">
</head>
<body>
    <header>
        <nav>
            <a href="../index.html" class="logo">Пишу про IT</a>
            <button class="mobile-menu-btn" aria-label="Menu" aria-expanded="false">☰</button>
            <ul class="nav-links">
                <li><a href="../index.html">Главная</a></li>
                <li><a href="../about.html">Обо мне</a></li>
            </ul>
        </nav>
    </header>

    <main>
        <a href="../index.html" class="back-link">← Назад к статьям</a>

        <article>
            <header>
                <h1>Управление временем жизни задач в Go с context</h1>
                <div class="article-meta">
                    <span>2 ноября 2025</span>
                    <span>•</span>
                    <span>Go, Concurrency</span>
                </div>
                <div class="article-tags">
                    <span class="tag">go</span>
                    <span class="tag">context</span>
                    <span class="tag">concurrency</span>
                </div>
            </header>

            <div class="article-content">
                <p>В Go пакет <code>context</code> помогает ограничить время выполнения и отменять операции. Это один из ключевых инструментов для работы с конкурентностью в Go, который позволяет контролировать время жизни горутин и передавать сигналы отмены между ними.</p>

                <h2>Зачем нужен context?</h2>
                <p>Context решает несколько важных задач:</p>
                <ul>
                    <li>Установка таймаутов для операций</li>
                    <li>Отмена долгих операций по требованию</li>
                    <li>Передача значений между функциями (хотя это нужно использовать осторожно)</li>
                    <li>Координация работы множества горутин</li>
                </ul>

                <h2>Базовый пример</h2>
                <p>Рассмотрим простой пример использования <code>context.WithTimeout</code> для ограничения времени выполнения операции:</p>

<pre><code class="language-go">package main

import (
  "context"
  "fmt"
  "time"
)

func main() {
  ctx, cancel := context.WithTimeout(context.Background(), 2*time.Second)
  defer cancel()

  done := make(chan struct{})
  go func() {
    time.Sleep(1500 * time.Millisecond)
    fmt.Println("work done")
    close(done)
  }()

  select {
  case &lt;-done:
    fmt.Println("ok")
  case &lt;-ctx.Done():
    fmt.Println("timeout:", ctx.Err())
  }
}</code></pre>

                <p>В этом примере мы создаем контекст с таймаутом в 2 секунды. Горутина завершает работу за 1.5 секунды, поэтому программа успевает обработать результат до истечения таймаута.</p>

                <p>При запуске программы вы увидите следующий вывод:</p>

                <img src="../assets/img/example-screenshot.svg" alt="Пример вывода программы в терминале" loading="lazy">

                <h2>Типы контекстов</h2>
                <p>Go предоставляет несколько функций для создания контекстов:</p>

                <h3>context.Background()</h3>
                <p>Базовый контекст, используется как корневой контекст в main функции или при инициализации.</p>

<pre><code class="language-go">ctx := context.Background()</code></pre>

                <h3>context.WithTimeout</h3>
                <p>Создает контекст, который автоматически отменяется через указанное время.</p>

<pre><code class="language-go">ctx, cancel := context.WithTimeout(parent, 5*time.Second)
defer cancel()</code></pre>

                <h3>context.WithCancel</h3>
                <p>Создает контекст, который можно отменить вручную в любой момент.</p>

<pre><code class="language-go">ctx, cancel := context.WithCancel(parent)
// Позже, когда нужно отменить
cancel()</code></pre>

                <h3>context.WithDeadline</h3>
                <p>Похож на WithTimeout, но принимает конкретное время вместо длительности.</p>

<pre><code class="language-go">deadline := time.Now().Add(10 * time.Second)
ctx, cancel := context.WithDeadline(parent, deadline)
defer cancel()</code></pre>

                <h2>Практический пример с HTTP запросом</h2>
                <p>Вот более практичный пример использования контекста для HTTP запроса с таймаутом:</p>

<pre><code class="language-go">func fetchData(ctx context.Context, url string) error {
  req, err := http.NewRequestWithContext(ctx, "GET", url, nil)
  if err != nil {
    return err
  }

  client := &amp;http.Client{}
  resp, err := client.Do(req)
  if err != nil {
    return err
  }
  defer resp.Body.Close()

  // Обработка ответа...
  return nil
}

func main() {
  ctx, cancel := context.WithTimeout(context.Background(), 3*time.Second)
  defer cancel()

  if err := fetchData(ctx, "https://api.example.com/data"); err != nil {
    log.Printf("Request failed: %v", err)
  }
}</code></pre>

                <h2>Важные правила</h2>
                <blockquote>
                    Всегда вызывайте функцию cancel, полученную при создании контекста, чтобы освободить ресурсы. Используйте defer cancel() сразу после создания контекста.
                </blockquote>

                <p>Другие важные моменты:</p>
                <ul>
                    <li>Не храните контекст в структурах - передавайте его как первый параметр функции</li>
                    <li>Не передавайте nil контекст - используйте <code>context.Background()</code> или <code>context.TODO()</code></li>
                    <li>Используйте контекст для передачи только request-scoped данных</li>
                    <li>Context безопасен для использования из нескольких горутин одновременно</li>
                </ul>

                <h2>Заключение</h2>
                <p>Пакет context - это мощный инструмент для управления жизненным циклом операций в Go. Правильное использование контекста помогает писать более надежный и предсказуемый код, особенно в высоконагруженных системах.</p>

                <p>Для более глубокого понимания рекомендую изучить <a href="https://pkg.go.dev/context">официальную документацию</a> и <a href="https://go.dev/blog/context">блог пост от команды Go</a>.</p>
            </div>
        </article>
    </main>

    <footer>
        <p>&copy; 2025 Владислав Дедов. Все права защищены.</p>
        <p>Блог о разработке и технологиях</p>
    </footer>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/languages/go.min.js"></script>
    <script src="../assets/js/script.js"></script>
</body>
</html>
